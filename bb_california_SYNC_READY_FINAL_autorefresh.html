<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>B&amp;B California ¬∑ PMS (Web)</title>
<link href="https://cdn.jsdelivr.net" rel="preconnect"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
<style>
  :root{
    --col-prim:#0ea5a6;
    --col-sec:#ff7043;
    --col-bg1:#f0fbfd;
    --col-bg2:#fff9f5;
    --col-card:#ffffff;
    --col-text:#0F172A;
    --col-border:#E2E8F0;
    --col-danger:#ff4d4f;
    --col-danger-bg:#ffecec;
    --col-paid:#10b981;    /* verde */
    --col-unpaid:#ef4444;  /* rosso */
    --col-deposit:#f59e0b; /* giallo */
    --cell-paid:#e8fff5;    /* sfondo verde chiaro */
    --cell-unpaid:#ffecec;  /* sfondo rosso chiaro */
    --cell-deposit:#fff8e1; /* sfondo giallo chiaro */
    --cell-dirty:#dbeafe;   /* BLU CHIARO: camera da pulire nel giorno selezionato */
  }
  html,body{height:100%}
  body{ color:var(--col-text); background: linear-gradient(120deg, var(--col-bg1), var(--col-bg2)); background-attachment: fixed; }
  .card{ background:var(--col-card); box-shadow:0 8px 24px rgba(15,23,42,.06); border:1px solid var(--col-border); }
  .btn-primary{ background:var(--col-prim); border-color:var(--col-prim); }
  .btn-outline-primary{ color:var(--col-prim); border-color:var(--col-prim); }
  .btn-outline-primary:hover{ background:var(--col-prim); color:#fff; }
  .navbar-brand{ color:var(--col-prim); font-weight:700; letter-spacing:.2px; display:flex; align-items:center; gap:.5rem; }
  .navbar-brand img{ height:28px; width:auto; display:block; }
  .toolbar{ position:relative; background:rgba(255,255,255,.6); backdrop-filter: blur(8px); border:1px solid var(--col-border); border-radius:12px; padding:.5rem .75rem; z-index:1051; }
  .dropdown-menu{ z-index:2000; }
  .table thead th{ position:sticky; top:0; background: #f8fafc; z-index:1; }
  .cell{ border:1px solid var(--col-border); min-width:100px; height:40px; font-size:12px; padding:2px 6px; vertical-align:middle; }
  .occ{ border:1px dashed var(--col-prim); color:inherit; border-radius:6px; padding:2px 6px; display:inline-flex; align-items:center; gap:6px; font-weight:600; cursor:move; background:transparent; }
  .free-day{ color:var(--col-prim); text-decoration:none; font-size:18px; line-height:1; }
  .free-day:hover{ color:#0b8d8e; }
  .room-col{ width:180px; background:#fafcff; }
  .note{ color:#64748B; font-size:0.9rem; }
  .room-unavailable .room-col-cell{ background:var(--col-danger); color:#fff; }
  .room-unavailable .cell{ background:var(--col-danger-bg); }
  .badge-dot{ width:8px; height:8px; border-radius:50%; display:inline-block; }
  .dot-paid{ background:var(--col-paid); box-shadow:0 0 0 2px rgba(16,185,129,.15); }
  .dot-unpaid{ background:var(--col-unpaid); box-shadow:0 0 0 2px rgba(239,68,68,.15); }
  .dot-deposit{ background:var(--col-deposit); box-shadow:0 0 0 2px rgba(245,158,11,.2); }
  .cell-paid{ background:var(--cell-paid) !important; }
  .cell-unpaid{ background:var(--cell-unpaid) !important; }
  .cell-deposit{ background:var(--cell-deposit) !important; }
  .cell-dirty{ background:var(--cell-dirty) !important; }
  .chart-box{ height:240px; }
  .scroll-table{ max-height:320px; overflow:auto; border:1px solid var(--col-border); border-radius:8px; }
  @media (max-width: 992px){ .cell{ min-width:80px; font-size:11px; } .room-col{ width:140px; } }
  @media (max-width: 576px){ .cell{ min-width:64px; font-size:10px; } .room-col{ width:120px; } .toolbar{ gap:.4rem; } .navbar-brand{ font-size:1rem; } .hide-xs{ display:none !important; } }

  .legend-badges .badge-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; vertical-align:middle; margin-right:6px; }

/* === UX: sticky prima colonna e hint scroll nel Calendario === */
.table .room-col-cell{position:sticky;left:0;z-index:2;background:#fff;box-shadow:8px 0 12px rgba(15,23,42,.06);} 
#calendarContainer{position:relative;} 
#calendarContainer .scroll-hint{position:absolute;right:12px;top:8px;background:rgba(0,0,0,.55);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;} 
@media (max-width:576px){ .chart-box{height:200px;} }


/* === Mobile fit tweaks (tutte le pagine) === */
@media (max-width:576px){
  body{padding:.75rem !important;}
  .card{margin-bottom:.75rem;}
  .table{font-size:12px;}
  .btn, .btn-sm{white-space:nowrap;}
  .input-group>.form-control{min-width:0;}
}


/* Sidebar: nascondi toolbar originale */
.toolbar{ display:none !important; }
#appSidebar .list-group-item{ cursor:pointer; }
#topbar{ background:rgba(255,255,255,.9); backdrop-filter: blur(6px); }
@media (min-width: 992px){ #topbar{ position:sticky; top:0; z-index:1050; } }
#topbar .fw-bold{ white-space:nowrap; }

/* --- Sticky header first column (Camera) --- */
#calendarContainer { position: relative; }
#calendarContainer table thead th:first-child {
  position: sticky; left: 0; z-index: 4; background: #fff;
  box-shadow: 8px 0 12px rgba(15,23,42,.06);
}
#calendarContainer table tbody td:first-child {
  position: sticky; left: 0; z-index: 3; background: #fff;
  box-shadow: 8px 0 12px rgba(15,23,42,.06);
}
#calendarContainer table thead th:first-child,
#calendarContainer table tbody td:first-child {
  white-space: nowrap; -webkit-backface-visibility: hidden; backface-visibility: hidden;
}


/* --- Responsive action bars (top controls) --- */
.resp-toolbar{ display:flex; flex-wrap:wrap; gap:.5rem; min-width:0; }
.resp-toolbar > *{ flex: 0 1 auto; min-width: 0; }
.resp-toolbar .btn{ white-space:nowrap; }
.resp-toolbar .input-group>.form-control{ min-width: 0; }


/* --- XS/SM stacking for Dashboard & Calendar toolbars --- */
@media (max-width: 576px){
  #viewDashboard .resp-toolbar,
  #viewCalendar .resp-toolbar{ flex-direction: column; align-items: stretch; justify-content:flex-start; }
  #viewDashboard .resp-toolbar > .d-flex,
  #viewCalendar  .resp-toolbar > .d-flex{ flex-wrap: wrap; gap:.4rem; }
  #viewDashboard .resp-toolbar input[type="date"],
  #viewCalendar  .resp-toolbar input[type="date"]{ width: 110px !important; min-width:0; }
  #viewDashboard .resp-toolbar .btn,
  #viewCalendar  .resp-toolbar .btn{ padding:.35rem .5rem; font-size:.9rem; }
}
@media (max-width: 768px){
  #viewDashboard .resp-toolbar > .d-flex,
  #viewCalendar  .resp-toolbar > .d-flex{ flex-wrap: wrap; }
}


/* --- Bookings (Prenotazioni) compact filters --- */
#viewBookings .resp-toolbar{ display:flex; flex-wrap:wrap; gap:.5rem; }
#viewBookings .resp-toolbar > .col-md-3,
#viewBookings .resp-toolbar > .col-md-2,
#viewBookings .resp-toolbar > .col-12{ flex: 1 1 180px; min-width: 0; }
#viewBookings .resp-toolbar .btn{ white-space:nowrap; }
#viewBookings .resp-toolbar input[type="date"]{ width: 180px; }
#viewBookings .resp-toolbar select{ max-width: 200px; }
@media (max-width:768px){
  #viewBookings .resp-toolbar > .col-md-3,
  #viewBookings .resp-toolbar > .col-md-2{ flex: 1 1 160px; }
  #viewBookings .resp-toolbar input[type="date"]{ width: 150px; }
  #viewBookings .resp-toolbar select{ max-width: 170px; }
}
@media (max-width:576px){
  #viewBookings .resp-toolbar{ gap:.4rem; }
  #viewBookings .resp-toolbar > .col-md-3,
  #viewBookings .resp-toolbar > .col-md-2{ flex: 1 1 120px; }
  #viewBookings .resp-toolbar input[type="date"]{ width: 120px; }
  #viewBookings .resp-toolbar #bkGuest{ flex: 1 1 160px; min-width: 140px; }
  #viewBookings .resp-toolbar select{ max-width: 150px; }
  #viewBookings .resp-toolbar .btn{ padding:.35rem .5rem; font-size:.9rem; }
}


/* Evidenza pi√π chiara per carry-over: bordo blu */
.cell.cell-dirty{ outline: 1px solid rgba(30,144,255,0.5); }
</style>
</head>
<body class="p-3" id="body">
<!-- === TOPBAR + SIDEBAR (OFFCANVAS) === -->
<div class="d-flex align-items-center gap-2 p-2 border-bottom" id="topbar">
<button aria-controls="appSidebar" class="btn btn-outline-primary btn-sm" data-bs-target="#appSidebar" data-bs-toggle="offcanvas" type="button">
<i class="bi bi-list"></i>
</button>
<div class="fw-bold d-lg-none">Menu</div>
<div class="fw-bold d-none d-lg-block">B&amp;B California</div>
</div>
<div aria-labelledby="appSidebarLabel" class="offcanvas offcanvas-start" id="appSidebar" tabindex="-1">
<div class="offcanvas-header">
<h5 class="offcanvas-title" id="appSidebarLabel">B&amp;B California</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button"></button>
</div>
<div class="offcanvas-body sidebar-offcanvas d-flex flex-column gap-3">
<div class="list-group">
<a class="list-group-item list-group-item-action" data-bs-dismiss="offcanvas" onclick="try{renderDashboard();show(viewDashboard);}catch(e){}">
<i class="bi bi-speedometer2 text-primary"></i> Dashboard
      </a>
<a class="list-group-item list-group-item-action" data-bs-dismiss="offcanvas" onclick="try{renderCalendar();show(viewCalendar);}catch(e){}">
<i class="bi bi-calendar-event text-info"></i> Calendario
      </a>
<a class="list-group-item list-group-item-action" data-bs-dismiss="offcanvas" onclick="try{presetBookingsFilter();renderBookingsTable();show(viewBookings);}catch(e){}">
<i class="bi bi-journal-text text-success"></i> Prenotazioni
      </a>
<a class="list-group-item list-group-item-action" data-bs-dismiss="offcanvas" onclick="try{presetReportDates();show(viewReports);setTimeout(()=&gt;computeReport(),0);}catch(e){}">
<i class="bi bi-graph-up text-warning"></i> Report
      </a>
<a class="list-group-item list-group-item-action" data-bs-dismiss="offcanvas" onclick="try{renderRooms();show(viewRooms);}catch(e){}">
<i class="bi bi-door-closed text-danger"></i> Camere
      </a>
<a class="list-group-item list-group-item-action" data-bs-dismiss="offcanvas" onclick="try{exportExcel();}catch(e){}">
<i class="bi bi-file-earmark-excel text-success"></i> Esporta Excel
      </a>
</div>
<div>
<label class="form-label">Ricerca globale</label>
<div class="input-group input-group-sm">
<span class="input-group-text"><i class="bi bi-search"></i></span>
<input class="form-control" id="sbSearchInput" placeholder="Cerca ospite/telefono/email/note"/>
<button class="btn btn-outline-primary" id="sbSearchBtn">Cerca</button>
</div>
</div>
</div>
</div>
<nav class="mb-3 d-flex gap-2 align-items-center toolbar flex-wrap">
<span class="navbar-brand mb-0" id="brandArea">
<img alt="Albergo California logo" id="brandLogo"/>
<span class="hide-xs" id="brandText">B&amp;B California</span>
</span>
<button class="btn btn-sm btn-outline-primary" id="btnDashboard"><i class="bi bi-speedometer2 text-primary"></i> <span class="hide-xs">Dashboard</span></button>
<button class="btn btn-sm btn-outline-primary" id="btnCalendar"><i class="bi bi-calendar-event text-info"></i> <span class="hide-xs">Calendario</span></button>
<button class="btn btn-sm btn-outline-primary" id="btnBookings"><i class="bi bi-journal-text text-success"></i> <span class="hide-xs">Prenotazioni</span></button>
<div class="btn-group">
<button class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-display="static" data-bs-toggle="dropdown">
<i class="bi bi-printer"></i> <span class="hide-xs">Stampe PDF</span>
</button>
<ul class="dropdown-menu dropdown-menu-end">
<li><a class="dropdown-item" href="#" id="printArriviOggi">Arrivi oggi</a></li>
<li><a class="dropdown-item" href="#" id="printPartenzeOggi">Partenze oggi</a></li>
<li><a class="dropdown-item" href="#" id="printSituazioneOggi">Situazione camere (oggi)</a></li>
<li><hr class="dropdown-divider"/></li>
<li><a class="dropdown-item" href="#" id="printReportPeriodo">Report (periodo corrente)</a></li>
</ul>
</div>
<button class="btn btn-sm btn-outline-primary" id="btnReports"><i class="bi bi-graph-up text-warning"></i> <span class="hide-xs">Report</span></button>
<button class="btn btn-sm btn-outline-primary" id="btnRooms"><i class="bi bi-door-closed text-danger"></i> <span class="hide-xs">Camere</span></button>
<div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
<div class="input-group input-group-sm" style="width:260px;">
<span class="input-group-text"><i class="bi bi-search"></i></span>
<input class="form-control" id="globalSearchInput" placeholder="Cerca ospite/telefono/email/note" type="text"/>
<button class="btn btn-outline-primary" id="globalSearchBtn">Cerca</button>
</div>
<div class="btn-group">
<button class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-display="static" data-bs-toggle="dropdown">
<i class="bi bi-gear"></i> <span class="hide-xs">Impostazioni</span>
</button>
<ul class="dropdown-menu dropdown-menu-end">
<li><a class="dropdown-item" data-bs-target="#settingsModal" data-bs-toggle="modal" href="#">Logo &amp; Preferenze</a></li>
</ul>
</div>
<button class="btn btn-sm btn-outline-primary" id="btnExport"><i class="bi bi-file-earmark-excel text-success"></i> <span class="hide-xs">Esporta Excel</span></button>
<button class="btn btn-sm btn-outline-primary" id="btnReset"><i class="bi bi-trash"></i> <span class="hide-xs">Cancella tutto</span></button>
</div>
</nav>
<div class="container-fluid">
<!-- DASHBOARD -->
<section class="d-none" id="viewDashboard">
<div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2 resp-toolbar">
<div class="d-flex align-items-center gap-2">
<h4 class="mb-0">Dashboard</h4>
<span class="text-muted small" id="todayLabel"></span>
</div>
<div class="d-flex gap-2 align-items-center">
<button class="btn btn-sm btn-outline-primary" id="dashPrev">‚óÄÔ∏è Indietro</button>
<input class="form-control form-control-sm" id="dashDate" style="width: 180px;" type="date"/>
<button class="btn btn-sm btn-outline-primary" id="dashToday">Oggi</button>
<button class="btn btn-sm btn-outline-primary" id="dashNext">Avanti ‚ñ∂Ô∏è</button>
</div>
</div>
<div class="row g-3 mb-3">
<div class="col-sm-4"><div class="card p-3 text-center"><div class="fw-bold">Arrivi</div><div class="display-6" id="kpiArrivalsNum">0</div></div></div>
<div class="col-sm-4"><div class="card p-3 text-center"><div class="fw-bold">Partenze</div><div class="display-6" id="kpiDeparturesNum">0</div></div></div>
<div class="col-sm-4"><div class="card p-3 text-center"><div class="fw-bold">Camere libere</div><div class="display-6" id="kpiFreeNum">0</div></div></div>
</div>
<div class="row g-3">
<div class="col-lg-4">
<div class="card p-3">
<div class="d-flex align-items-center justify-content-between">
<b class="mb-0">Arrivi</b>
<span class="badge bg-primary" id="kpiArrivals">0</span>
</div>
<div class="table-responsive mt-2">
<table class="table table-sm mb-0" id="tblArrivi"><thead><tr><th>Ospite</th><th>Camera</th><th>Check‚Äëin</th></tr></thead><tbody></tbody></table>
</div>
</div>
</div>
<div class="col-lg-4">
<div class="card p-3">
<div class="d-flex align-items-center justify-content-between">
<b class="mb-0">Partenze</b>
<span class="badge bg-primary" id="kpiDepartures">0</span>
</div>
<div class="table-responsive mt-2">
<table class="table table-sm mb-0" id="tblPartenze"><thead><tr><th>Ospite</th><th>Camera</th><th>Check‚Äëout</th></tr></thead><tbody></tbody></table>
</div>
</div>
</div>
<div class="col-lg-4">
<div class="card p-3">
<div class="d-flex align-items-center justify-content-between">
<b class="mb-0">Camere da pulire (partenze)</b>
<span class="badge bg-warning text-dark" id="kpiDirty">0</span>
</div>
<div class="table-responsive mt-2">
<table class="table table-sm mb-2" id="tblDirty"><thead><tr><th>Camera</th><th>Ospite</th><th></th></tr></thead><tbody></tbody></table>
</div>
<div class="table-responsive mt-2">
<div class="small text-muted mb-1">Camere gi√† segnate pulite (giorno selezionato)</div>
<table class="table table-sm mb-0" id="tblClean"><thead><tr><th>Camera</th><th></th></tr></thead><tbody></tbody></table>
</div>
</div>
</div>
</div>
</section>
<!-- CALENDARIO -->
<section class="d-none" id="viewCalendar">
<div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2 resp-toolbar">
<div class="d-flex align-items-center gap-2">
<h4 class="mb-0">Calendario</h4>
<select class="form-select form-select-sm" id="rangeSelect" style="width:auto;">
<option selected="" value="7">7 giorni</option>
<option value="14">14 giorni</option>
<option value="21">21 giorni</option>
</select>
</div>
<div class="d-flex gap-2 align-items-center">
<button class="btn btn-sm btn-outline-primary" id="prevWeek">‚óÄÔ∏è Indietro</button>
<button class="btn btn-sm btn-outline-primary" id="todayBtn">Oggi</button>
<button class="btn btn-sm btn-outline-primary" id="nextWeek">Avanti ‚ñ∂Ô∏è</button>
<input class="form-control form-control-sm" id="jumpDate" style="width: 180px;" type="date"/>
<button class="btn btn-sm btn-primary" id="jumpGo">Vai</button>
</div>
</div>
<p class="note">Clic su ‚Äú+‚Äù per creare, clic su <b>Nome Cognome</b> per <b>modificare</b>, trascina per <b>spostare</b>.</p>
<p class="note">Legenda: Rosso = Non pagato; Verde = Pagato; Giallo = Acconto.</p>
<div class="table-responsive" id="calendarContainer"></div>
</section>
<!-- PRENOTAZIONI -->
<section class="d-none" id="viewBookings">
<h4>Prenotazioni</h4>
<form class="row g-3 align-items-end mb-3 resp-toolbar" id="bookingsFilterForm">
<div class="col-md-3">
<label class="form-label">Dal</label>
<input class="form-control" id="bkFrom" type="date"/>
</div>
<div class="col-md-3">
<label class="form-label">Al (incluso)</label>
<input class="form-control" id="bkTo" type="date"/>
</div>
<div class="col-md-2">
<label class="form-label">Pagamento</label>
<select class="form-select" id="bkPay">
<option value="all">Tutti</option>
<option value="paid">Pagato</option>
<option value="deposit">Acconto</option>
<option value="unpaid">Non pagato</option>
</select>
</div>
<div class="col-md-2">
<label class="form-label">Sorgente</label>
<select class="form-select" id="bkSource">
<option value="all">Tutte</option>
<option value="Telefono">Telefono</option>
<option value="Sito internet">Sito internet</option>
<option value="Booking">Booking</option>
</select>
</div>
<div class="col-md-2">
<label class="form-label">Ospite</label>
<input class="form-control" id="bkGuest" placeholder="Nome o cognome"/>
</div>
<div class="col-12">
<button class="btn btn-primary" type="submit">Filtra</button>
</div>
</form>
<div class="table-responsive">
<table class="table table-sm align-middle" id="bookingsTable">
<thead><tr><th>#</th><th>Camera</th><th>Ospite</th><th>Check‚Äëin</th><th>Check‚Äëout</th><th>Tariffa totale (‚Ç¨)</th><th>Tariffa giornaliera (‚Ç¨)</th><th>Acconto (‚Ç¨)</th><th>Sorgente</th><th>Pagamento</th><th class="hide-xs">Note</th><th></th></tr></thead>
<tbody></tbody>
</table>
</div>
</section>
<!-- REPORT -->
<section class="d-none" id="viewReports">
<h4>Report</h4>
<form class="row g-3 align-items-end mb-3 resp-toolbar" id="reportForm">
<div class="col-sm-3">
<label class="form-label">Dal</label>
<input class="form-control" id="repFrom" type="date"/>
</div>
<div class="col-sm-3">
<label class="form-label">Al (incluso)</label>
<input class="form-control" id="repTo" type="date"/>
</div>
<div class="col-sm-3">
<label class="form-label">Pagamento</label>
<select class="form-select" id="repPayFilter">
<option value="all">Tutti</option>
<option value="paid">Pagato</option>
<option value="deposit">Acconto</option>
<option value="unpaid">Non pagato</option>
</select>
</div>
<div class="col-sm-3">
<button class="btn btn-primary" type="submit">Calcola</button>
</div>
</form>
<!-- ORDINE: Non pagato ‚Ç¨, Totale prenotazioni ‚Ç¨, Ricavi totali ‚Ç¨ -->
<div class="row g-3 mb-3">
<div class="col-md-4"><div class="card p-3"><b>Non pagato ‚Ç¨</b><div class="fs-4">‚Ç¨ <span id="repOutstanding">0.00</span></div></div></div>
<div class="col-md-4"><div class="card p-3"><b>Totale prenotazioni ‚Ç¨</b><div class="fs-4">‚Ç¨ <span id="repTotalAll">0.00</span></div></div></div>
<div class="col-md-4"><div class="card p-3"><b>Ricavi totali ‚Ç¨</b><div class="fs-4">‚Ç¨ <span id="repRevenue">0.00</span></div></div></div>
</div>
<div class="alert alert-info" role="alert">
<div class="fw-bold mb-1">Legenda KPI</div>
<ul class="mb-0">
<li><b>Ricavi totali ‚Ç¨</b>: somme <u>effettivamente incassate</u> nel periodo (Pagato = 100% del totale; Acconto = solo importo acconto; Non pagato = 0).</li>
<li><b>Totale prenotazioni ‚Ç¨</b>: somma di <u>tutti i totali</u> delle prenotazioni nel periodo (pagate e non).</li>
<li><b>Non pagato ‚Ç¨</b>: importo <u>ancora da incassare</u> (Non pagato = 100% del totale; Acconto = Totale ‚àí Acconto; Pagato = 0).</li>
<li class="mt-1"><b>Incassi effettivi (grafico)</b>: attribuiti alla <u>data di check‚Äëin</u> della prenotazione (senza data incasso puntuale).</li>
</ul>
</div>
<div class="row g-3">
<div class="col-xl-6">
<div class="card p-3 chart-box">
<h6 class="mb-2">Occupazione giornaliera (%)</h6>
<canvas id="occChart"></canvas>
</div>
</div>
<div class="col-xl-6">
<div class="card p-3 chart-box">
<h6 class="mb-2">Incassi effettivi (‚Ç¨)</h6>
<canvas id="revChart"></canvas>
</div>
</div>
</div>
<h6 class="mt-4">Dettaglio occupazione</h6>
<div class="scroll-table">
<table class="table table-sm mb-0" id="repTable">
<thead><tr><th>Data</th><th>Camere vendute</th><th>Incasso (‚Ç¨)</th></tr></thead>
<tbody></tbody>
</table>
</div>
<h6 class="mt-4">Sorgenti prenotazione</h6>
<div class="table-responsive">
<table class="table table-sm" id="repSources">
<thead><tr><th>Canale</th><th>Prenotazioni</th><th>Ricavi (‚Ç¨)</th></tr></thead>
<tbody></tbody>
</table>
</div>
</section>
<!-- CAMERE -->
<section class="d-none" id="viewRooms">
<h4>Gestione Camere</h4>
<p class="note">Modifica nome, capacit√† o stato. I numeri camera partono da <b>1</b> a <b>13</b>. Le camere in <b>Manutenzione/Fuori servizio</b> appaiono <b>rosse</b> nel calendario.</p>
<div class="table-responsive">
<table class="table table-sm align-middle">
<thead><tr><th>#</th><th>Nome</th><th>Capacit√†</th><th>Stato</th><th></th></tr></thead>
<tbody id="roomsBody"></tbody>
</table>
</div>
</section>
</div>
<!-- MODALE PRENOTAZIONE -->
<div aria-hidden="true" class="modal fade" id="newBookingModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="bookingModalTitle">Nuova prenotazione</h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<form class="modal-body row g-3" id="newBookingForm">
<input name="booking_id" type="hidden">
<div class="col-md-3"><label class="form-label">Nome</label><input class="form-control" name="first_name" required=""/></div>
<div class="col-md-3"><label class="form-label">Cognome</label><input class="form-control" name="last_name" required=""/></div>
<div class="col-md-3"><label class="form-label">Email</label><input class="form-control" name="email" type="email"/></div>
<div class="col-md-3"><label class="form-label">Telefono</label><input class="form-control" name="phone"/></div>
<div class="col-md-3"><label class="form-label">Camera</label><select class="form-select" id="roomSelect" name="room_id"></select></div>
<div class="col-md-3"><label class="form-label">Check‚Äëin</label><input class="form-control" id="checkinInput" name="checkin" required="" type="date"/></div>
<div class="col-md-3"><label class="form-label">Check‚Äëout</label><input class="form-control" id="checkoutInput" name="checkout" required="" type="date"/></div>
<div class="col-md-3"><label class="form-label">Pagamento</label><select class="form-select" id="payment_status" name="payment_status"><option value="unpaid">Non pagato</option><option value="deposit">Acconto</option><option value="paid">Pagato</option></select></div>
<div class="col-md-3 d-none" id="depositGroup"><label class="form-label">Acconto (‚Ç¨)</label><input class="form-control" id="deposit_amount" min="0" name="deposit_amount" step="0.01" type="number" value="0.00"/></div>
<div class="col-md-3"><label class="form-label">Sorgente</label><select class="form-select" name="source"><option value="Telefono">Telefono</option><option value="Sito internet">Sito internet</option><option value="Booking">Booking</option></select></div>
<div class="col-md-3"><label class="form-label">Tariffa totale (‚Ç¨/soggiorno)</label><input class="form-control" id="rate_total" min="0" name="rate_total" step="0.01" type="number" value="0.00"/><div class="invalid-feedback" id="rate_total_fb"></div></div>
<div class="col-md-3"><label class="form-label">Tariffa giornaliera (‚Ç¨/notte)</label><input class="form-control" id="rate_daily" min="0" name="rate_daily" step="0.01" type="number" value="0.00"/><div class="invalid-feedback" id="rate_daily_fb"></div></div>
<div class="col-12"><label class="form-label">Note</label><textarea class="form-control" name="notes" placeholder="Es. orario arrivo, allergie, richieste..." rows="3"></textarea></div>
<!-- OMBRELLONE (v2) -->
<hr/>
<div class="col-12">
<label class="form-label d-block">Ombrellone</label>
<div aria-label="Ombrellone" class="btn-group" role="group">
<input checked="" class="btn-check" id="umb_no" name="umbrella_enabled" type="radio" value="no"/>
<label class="btn btn-outline-secondary" for="umb_no">No</label>
<input class="btn-check" id="umb_yes" name="umbrella_enabled" type="radio" value="yes"/>
<label class="btn btn-outline-secondary" for="umb_yes">S√¨</label>
</div>
</div>
<div class="col-12 d-none" id="umbrella_extra">
<div class="row g-2">
<div class="col-md-4">
<label class="form-label">Numero</label>
<select class="form-select" id="umbrella_number" name="umbrella_number">
<option value="">‚Äî</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
</select>
<div class='\"invalid-feedback\"' id='\"umbrella_number_fb\"'>Se scegli ‚ÄúS√¨‚Äù, devi selezionare un numero da 1 a 6.</div>
</div>
<div class="col-md-4">
<label class="form-label">Importo totale (‚Ç¨/soggiorno)</label>
<input class="form-control" id="umbrella_total" min="0" name="umbrella_total" step="0.01" type="number" value="0.00"/>
<div class="invalid-feedback" id="umbrella_total_fb"></div>
</div>
<div class="col-md-4">
<label class="form-label">Importo giornaliero (‚Ç¨/giorno)</label>
<input class="form-control" id="umbrella_daily" min="0" name="umbrella_daily" step="0.01" type="number" value="0.00"/>
<div class="invalid-feedback" id="umbrella_daily_fb"></div>
</div>
</div>
</div>
</input></form>
<div class="modal-footer">
<button class="btn btn-outline-primary" data-bs-dismiss="modal">Annulla</button>
<button class="btn btn-danger d-none" id="deleteBookingBtn"><i class="bi bi-trash"></i> Elimina</button>
<button class="btn btn-primary" id="saveBookingBtn" onclick='\"onSaveBookingClick()\"' type='\"button\"'>Salva</button>
</div>
</div></div>
</div>
<!-- MODALE IMPOSTAZIONI -->
<div aria-hidden="true" class="modal fade" id="settingsModal" tabindex="-1">
<div class="modal-dialog"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title">Impostazioni</h5><button class="btn-close" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body">
<div class="mb-3">
<label class="form-label">URL logo (PNG/SVG/JPG)</label>
<input class="form-control" id="logoUrlInput" placeholder="https://albergocalifornia.it/path/del/logo.png" type="url"/>
<div class="form-text">Predefinito: favicon del sito. Incolla qui l'URL del logo per sostituirlo.</div>
</div>
</div>
<div class="modal-footer"><button class="btn btn-outline-primary" data-bs-dismiss="modal">Chiudi</button><button class="btn btn-primary" id="saveSettingsBtn">Salva impostazioni</button></div>
</div></div>
</div>
<!-- MODALE RICERCA GLOBALE -->
<div aria-hidden="true" class="modal fade" id="globalSearchModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title">Risultati ricerca</h5><button class="btn-close" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body"><div class="table-responsive"><table class="table table-sm" id="globalSearchTable"><thead><tr><th>#</th><th>Ospite</th><th>Periodo</th><th>Camera</th><th>Sorgente</th><th>Pagamento</th><th>Acconto (‚Ç¨)</th><th>Note</th><th></th></tr></thead><tbody></tbody></table></div></div>
</div></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
/* STORAGE */
const LS_KEY='bb_california_pms';
const LS_LOGO='bb_california_logo_url';
const DEFAULT_LOGO_URL='https://albergocalifornia.it/favicon.ico'; // fallback al favicon del sito
const ROOMS_INIT=Array.from({length:13},(_,i)=>({id:i+1,code:String(i+1),name:'Camera '+String(i+1),capacity:2,status:'available'}));
function loadState(){const raw=localStorage.getItem(LS_KEY);if(!raw){const init={rooms:ROOMS_INIT,guests:[],bookings:[],housekeeping:{}};localStorage.setItem(LS_KEY,JSON.stringify(init));return init;}const data=JSON.parse(raw);if(!data.rooms||(data.rooms.length===12&&data.rooms[0].code==='101'))data.rooms=ROOMS_INIT; if(!data.housekeeping)data.housekeeping={}; return data;}
function saveState(s){localStorage.setItem(LS_KEY,JSON.stringify(s));}
let state=loadState();

/* LOGO */
function applyLogo(){ const url = localStorage.getItem(LS_LOGO) || DEFAULT_LOGO_URL; const img = document.getElementById('brandLogo'); const fallbackText = 'B&B California'; img.src = url; img.onerror = ()=>{ img.replaceWith(Object.assign(document.createElement('span'),{textContent:fallbackText, className:'fw-bold'})); } }
applyLogo();

/* UTIL */
const fmtEUR=n=>Number(n||0).toFixed(2);
const toISO=d=>(new Date(d.getTime()-d.getTimezoneOffset()*60000)).toISOString().slice(0,10);
const fromISOtoIT=s=>{const [y,m,d]=s.split('-');return `${d}-${m}-${y}`};
const parseISO=s=>{const [y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d)};
function eachDay(startDate,endDateExcl){const arr=[];for(let d=new Date(startDate);d<endDateExcl;d.setDate(d.getDate()+1)){arr.push(new Date(d));}return arr;}
function isOverlap(aStart,aEnd,bStart,bEnd){return(aStart<bEnd)&&(bStart<aEnd);}

/* NAV */
const viewDashboard=document.getElementById('viewDashboard');
const viewCalendar=document.getElementById('viewCalendar');
const viewReports=document.getElementById('viewReports');
const viewRooms=document.getElementById('viewRooms');
const viewBookings=document.getElementById('viewBookings');
function show(view){[viewDashboard,viewCalendar,viewReports,viewRooms,viewBookings].forEach(v=>v.classList.add('d-none'));view.classList.remove('d-none');}

document.getElementById('btnDashboard').onclick=()=>{renderDashboard();show(viewDashboard)};
document.getElementById('btnCalendar').onclick=()=>{renderCalendar();show(viewCalendar)};
document.getElementById('btnReports').onclick=()=>{presetReportDates();show(viewReports);requestAnimationFrame(()=>computeReport())};
document.getElementById('btnRooms').onclick=()=>{renderRooms();show(viewRooms)};
document.getElementById('btnBookings').onclick=()=>{presetBookingsFilter();renderBookingsTable();show(viewBookings)};

/* SETTINGS */
const logoUrlInput=document.getElementById('logoUrlInput');
document.getElementById('settingsModal').addEventListener('show.bs.modal',()=>{ logoUrlInput.value=localStorage.getItem(LS_LOGO)||''; });
document.getElementById('saveSettingsBtn').onclick=()=>{ const v=(logoUrlInput.value||'').trim(); if(v){ localStorage.setItem(LS_LOGO,v); } else { localStorage.removeItem(LS_LOGO); } applyLogo(); bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide(); };

/* DASHBOARD */
let dashRefDate=toISO(new Date());
const dashDateInp=document.getElementById('dashDate');dashDateInp.value=dashRefDate;
document.getElementById('dashPrev').onclick=()=>{const d=parseISO(dashRefDate);d.setDate(d.getDate()-1);dashRefDate=toISO(d);dashDateInp.value=dashRefDate;renderDashboard();};
document.getElementById('dashNext').onclick=()=>{const d=parseISO(dashRefDate);d.setDate(d.getDate()+1);dashRefDate=toISO(d);dashDateInp.value=dashRefDate;renderDashboard();};
document.getElementById('dashToday').onclick=()=>{dashRefDate=toISO(new Date());dashDateInp.value=dashRefDate;renderDashboard();};
dashDateInp.addEventListener('change',()=>{if(dashDateInp.value){dashRefDate=dashDateInp.value;renderDashboard();}});

function getDirtyRooms(dateISO){
  // Carry-over corretto: evita ombreggiamento del helper globale toISO
  try{
    const refISO = dateISO;
    const refD = parseISO(refISO);
    const guestById = Object.fromEntries(state.guests.map(g => [g.id, g]));

    // Partenze con checkout <= data selezionata
    const deps = state.bookings
      .filter(b => {
        if(!b || b.status==='cancelled' || typeof b.checkout!=='string') return false;
        const co = parseISO(b.checkout);
        return !isNaN(co) && co <= refD;
      })
      .sort((a,b) => a.checkout.localeCompare(b.checkout));

    // Tieni solo l'ultima partenza per camera
    const latestByRoom = new Map();
    for(const b of deps){
      const prev = latestByRoom.get(b.room_id);
      if(!prev || b.checkout > prev.checkout){
        latestByRoom.set(b.room_id, b);
      }
    }

    // ATTENZIONE: nome parametro NON deve essere 'toISO' per non oscurare la funzione globale
    function hasCleanBetween(room_id, fromISO, toISORef){
      const start = parseISO(fromISO);
      const end   = parseISO(toISORef);
      if(isNaN(start) || isNaN(end)) return false;
      for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
        const ds = toISO(d); // usa helper globale toISO(d)
        const hk = (state.housekeeping[ds] || {});
        if(hk[room_id] === 'clean') return true;
      }
      return false;
    }

    const MS = 24*60*60*1000;
    const pending = [];
    latestByRoom.forEach((b) => {
      const isCleaned = hasCleanBetween(b.room_id, b.checkout, refISO);
      if(!isCleaned){
        const daysLate = Math.max(0, Math.round((refD - parseISO(b.checkout))/MS));
        pending.push({ room_id: b.room_id, guest: guestById[b.guest_id], checkout: b.checkout, daysLate });
      }
    });

    return pending;
  }catch(err){
    console.error('getDirtyRooms carry-over error:', err);
    // Fallback: solo partenze del giorno selezionato
    const hk = state.housekeeping[dateISO] || {};
    const guestById = Object.fromEntries(state.guests.map(g => [g.id,g]));
    const dirty = state.bookings
      .filter(b => b.status!=='cancelled' && b.checkout===dateISO)
      .map(b => ({room_id:b.room_id, guest:guestById[b.guest_id], checkout:b.checkout, daysLate:0}));
    return dirty.filter(d => hk[d.room_id] !== 'clean');
  }
}
function getCleanRooms(dateISO){const hk=state.housekeeping[dateISO]||{};return Object.entries(hk).filter(([rid,st])=>st==='clean').map(([rid])=>Number(rid));}
function markRoomClean(room_id){if(!state.housekeeping[dashRefDate])state.housekeeping[dashRefDate]={};state.housekeeping[dashRefDate][room_id]='clean';saveState(state);renderDashboard();renderCalendar();}
function markRoomDirty(room_id){if(!state.housekeeping[dashRefDate])state.housekeeping[dashRefDate]={};state.housekeeping[dashRefDate][room_id]='dirty';saveState(state);renderDashboard();renderCalendar();}

function renderDashboard(){
  const refISO=dashRefDate; const guestById=Object.fromEntries(state.guests.map(g=>[g.id,g])); const roomById=Object.fromEntries(state.rooms.map(r=>[r.id,r]));
  const todayLabel=document.getElementById('todayLabel'); if(todayLabel) todayLabel.textContent=refISO;
  const arrivals=state.bookings.filter(b=>b.status!=='cancelled'&&b.checkin===refISO);
  const departures=state.bookings.filter(b=>b.status!=='cancelled'&&b.checkout===refISO);
  const inhouse=state.bookings.filter(b=>{if(b.status==='cancelled')return false;return(b.checkin<=refISO)&&(refISO<b.checkout);}).length;
  const free=state.rooms.length-inhouse;
  document.getElementById('kpiArrivalsNum').textContent=arrivals.length;
  document.getElementById('kpiDeparturesNum').textContent=departures.length;
  document.getElementById('kpiFreeNum').textContent=free;
  document.getElementById('kpiArrivals').textContent=arrivals.length;
  document.getElementById('kpiDepartures').textContent=departures.length;
  const dirty=getDirtyRooms(refISO); document.getElementById('kpiDirty').textContent=dirty.length;
  const tA=document.querySelector('#tblArrivi tbody'); tA.innerHTML=arrivals.map(b=>{const g=guestById[b.guest_id]; const r=roomById[b.room_id]; return `<tr><td>${g?g.first_name+' '+g.last_name:''}</td><td>${r?r.code:''}</td><td>${fromISOtoIT(b.checkin)}</td></tr>`;}).join('')||'<tr><td colspan="3">Nessun arrivo</td></tr>';
  const tP=document.querySelector('#tblPartenze tbody'); tP.innerHTML=departures.map(b=>{const g=guestById[b.guest_id]; const r=roomById[b.room_id]; return `<tr><td>${g?g.first_name+' '+g.last_name:''}</td><td>${r?r.code:''}</td><td>${fromISOtoIT(b.checkout)}</td></tr>`;}).join('')||'<tr><td colspan="3">Nessuna partenza</td></tr>';
  const tD=document.querySelector('#tblDirty tbody');
 tD.innerHTML = dirty.map(d=>{ const r=roomById[d.room_id]; const g=d.guest; const extra= d.checkout?`<div class="small text-muted">checkout: ${fromISOtoIT(d.checkout)} ¬∑ ritardo: ${d.daysLate}g</div>`:''; return `<tr><td>${r?r.code:''}</td><td>${g?g.first_name+' '+g.last_name:''}${extra}</td><td><button class="btn btn-sm btn-success" onclick="markRoomClean(${d.room_id})"><i class="bi bi-check2-circle"></i> Segna pulita</button></td></tr>`; }).join('')
 || '<tr><td colspan="3">Nessuna camera da pulire</td></tr>';
 const cleanedRoomIds=getCleanRooms(refISO); const tC=document.querySelector('#tblClean tbody'); tC.innerHTML=cleanedRoomIds.map(rid=>{const r=roomById[rid]; return `<tr><td>${r?r.code:rid}</td><td><button class=\"btn btn-sm btn-warning\" onclick=\"markRoomDirty(${rid})\"><i class=\"bi bi-arrow-counterclockwise\"></i> Segna da pulire</button></td></tr>`;}).join('')||'<tr><td colspan="2">Nessuna camera segnata pulita</td></tr>';
}

/* CALENDARIO */
const calendarContainer=document.getElementById('calendarContainer');
let calStart=new Date(); calStart.setHours(0,0,0,0);
let rangeDays=7;
function setToday(){calStart=new Date();calStart.setHours(0,0,0,0);}

document.getElementById('todayBtn').onclick=()=>{setToday();renderCalendar();};
document.getElementById('prevWeek').onclick=()=>{calStart.setDate(calStart.getDate()-1);renderCalendar();};
document.getElementById('nextWeek').onclick=()=>{calStart.setDate(calStart.getDate()+1);renderCalendar();};
const jumpDate=document.getElementById('jumpDate'); document.getElementById('jumpGo').onclick=()=>{if(jumpDate.value){calStart=parseISO(jumpDate.value);renderCalendar();}};
const rangeSelect=document.getElementById('rangeSelect'); rangeSelect.value='7'; rangeSelect.onchange=()=>{rangeDays=Number(rangeSelect.value||7);renderCalendar();};

function isRoomDirtyOn(dateISO, room_id){
  try{
    // Non colorare oltre la data di oggi
    const todayISO = toISO(new Date());
    if(dateISO > todayISO) return false;

    // Ultimo checkout <= dateISO
    const upTo = parseISO(dateISO);
    if(isNaN(upTo)) return false;
    let lastCheckoutDate = null;
    for(const b of state.bookings){
      if(b.status==='cancelled') continue;
      if(b.room_id!==room_id) continue;
      const co = parseISO(b.checkout);
      if(isNaN(co)) continue;
      if(co <= upTo && (!lastCheckoutDate || co > lastCheckoutDate)){
        lastCheckoutDate = co;
      }
    }
    if(!lastCheckoutDate) return false;

    // Se esiste una pulizia in qualsiasi giorno >= lastCheckout, niente blu (anche retroattivo)
    for(const ds in (state.housekeeping||{})){
      const day = parseISO(ds);
      if(isNaN(day)) continue;
      if(day >= lastCheckoutDate){
        const hk = state.housekeeping[ds] || {};
        if(hk[room_id] === 'clean') return false;
      }
    }
    return true;
  }catch(e){ console.error('isRoomDirtyOn error:', e); return false; }
}

function toggleCleanFromCalendar(dateISO,room_id){if(!state.housekeeping[dateISO])state.housekeeping[dateISO]={}; const cur=state.housekeeping[dateISO][room_id]; state.housekeeping[dateISO][room_id]=(cur==='clean')?'dirty':'clean'; saveState(state); renderCalendar(); renderDashboard();}

function renderCalendar(){ const endDate=new Date(calStart.getFullYear(),calStart.getMonth(),calStart.getDate()+rangeDays); const days=eachDay(calStart,endDate); const guestById=Object.fromEntries(state.guests.map(g=>[g.id,g])); let html='<table class="table table-sm"><thead><tr><th class="room-col">Camera</th>'; days.forEach((d,idx)=>{html+=`<th class="text-center" data-col="${idx}">${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}</th>`}); html+='</tr></thead><tbody>'; const refISO=dashRefDate; for(const r of state.rooms){ const rowClass=(r.status==='maintenance'||r.status==='out_of_order')?'room-unavailable':''; html+=`<tr class="${rowClass}" data-room-id="${r.id}"><td class="room-col-cell"><b>${r.code}</b> <span class="text-muted">${r.name}</span></td>`; days.forEach((d,idx)=>{ const ds=toISO(d); const occ=state.bookings.find(b=>b.status!=='cancelled'&&b.room_id===r.id&&(b.checkin<=ds)&&(ds<b.checkout)); let cellCls='cell'; const _dirty = isRoomDirtyOn(ds, r.id); if(_dirty) cellCls+=' cell-dirty'; const cellAttrs=`class=\"${cellCls}\" data-room-id=\"${r.id}\" data-date=\"${ds}\" data-col=\"${idx}\" ondragover=\"onCellDragOver(event)\" ondrop=\"onCellDrop(event)\"`; if(occ){ const g=guestById[occ.guest_id]; const labelName=g?`${g.first_name} ${g.last_name}`:'Occupato'; const hasUmb=(occ && (occ.umbrella_enabled===true || occ.umbrella_enabled==='yes')); const umbrellaIcon=hasUmb?(' <span title=\"Ombrellone'+(occ.umbrella_number?(' n. '+occ.umbrella_number):'')+'\">üèñÔ∏è'+(occ.umbrella_number?(' '+occ.umbrella_number):'')+'</span>') : ''; const label=labelName+umbrellaIcon; const nights=Math.max(1,Math.round((parseISO(occ.checkout)-parseISO(occ.checkin))/(1000*60*60*24))); let dotClass='dot-unpaid'; let cellPay='cell-unpaid'; if(occ.payment_status==='paid'){dotClass='dot-paid';cellPay='cell-paid'} else if(occ.payment_status==='deposit'){dotClass='dot-deposit';cellPay='cell-deposit'}; const cellClsPay=cellCls+' '+cellPay; const cellAttrsPay=`class=\"${cellClsPay}\" data-room-id=\"${r.id}\" data-date=\"${ds}\" data-col=\"${idx}\" ondragover=\"onCellDragOver(event)\" ondrop=\"onCellDrop(event)\"`; html+=`<td ${cellAttrsPay}><span class=\"occ\" draggable=\"true\" ondragstart=\"onBookingDragStart(event)\" data-bid=\"${occ.id}\" data-nights=\"${nights}\" title=\"Prenotazione #${occ.id}\" onclick=\"openEditBooking(${occ.id})\"><span class=\"badge-dot ${dotClass}\"></span>${label}</span></td>`; } else { const onClick=(ds===refISO&&_dirty)?`onclick=\"toggleCleanFromCalendar('${ds}', ${r.id})\" title=\"Segna pulita/da pulire\"`:`onclick=\"openNewBooking(${r.id}, '${ds}', '${toISO(new Date(d.getTime()+86400000))}')\" title=\"Nuova prenotazione\"`; html+=`<td ${cellAttrs}><a class=\"free-day\" ${onClick.split(' ')[0]} ${onClick.split(' ').slice(1).join(' ')}>+</a></td>`; } }); html+='</tr>'; } html+='</tbody></table>'; calendarContainer.innerHTML=html; }

function onBookingDragStart(ev){ const bid=ev.target.getAttribute('data-bid'); const nights=Number(ev.target.getAttribute('data-nights'))||1; ev.dataTransfer.setData('text/plain',JSON.stringify({bid:Number(bid),nights})); }
function onCellDragOver(ev){ ev.preventDefault(); }
function onCellDrop(ev){ ev.preventDefault(); const data=JSON.parse(ev.dataTransfer.getData('text/plain')); const td=ev.currentTarget; const roomId=Number(td.getAttribute('data-room-id')); const date=td.getAttribute('data-date'); const room=state.rooms.find(r=>r.id===roomId); if(room&&(room.status==='maintenance'||room.status==='out_of_order')){ alert('La camera √® in manutenzione/fuori servizio.'); return; } const b=state.bookings.find(x=>x.id===data.bid); if(!b) return; const newCheckin=date; const newCheckout=toISO(new Date(parseISO(date).getTime()+data.nights*24*60*60*1000)); const conflict=state.bookings.some(x=>{ if(x.status==='cancelled') return false; if(x.id===b.id) return false; if(x.room_id!==roomId) return false; const aStart=parseISO(newCheckin),aEnd=parseISO(newCheckout); const bStart=parseISO(x.checkin),bEnd=parseISO(x.checkout); return isOverlap(aStart,aEnd,bStart,bEnd); }); if(conflict){ alert('Overbooking: impossibile spostare la prenotazione su queste date/camera.'); return; } b.room_id=roomId; b.checkin=newCheckin; b.checkout=newCheckout; saveState(state); renderCalendar(); renderDashboard(); renderBookingsTable(); }

/* MODALE PRENOTAZIONE */
const newBookingModal=new bootstrap.Modal(document.getElementById('newBookingModal'));
const roomSelect=document.getElementById('roomSelect');
const checkinInput=document.getElementById('checkinInput');
const checkoutInput=document.getElementById('checkoutInput');
const bookingModalTitle=document.getElementById('bookingModalTitle');
const deleteBookingBtn=document.getElementById('deleteBookingBtn');
const paymentStatusSel=document.getElementById('payment_status');
const depositGroup=document.getElementById('depositGroup');
const depositInput=document.getElementById('deposit_amount');
const rateTotalInput=document.getElementById('rate_total');
const rateDailyInput=document.getElementById('rate_daily');
const rateTotalFB=document.getElementById('rate_total_fb');
const rateDailyFB=document.getElementById('rate_daily_fb');

const umbrellaYes=document.getElementById('umb_yes');
const umbrellaNo=document.getElementById('umb_no');
const umbrellaExtra=document.getElementById('umbrella_extra');
const umbrellaNumberSel=document.getElementById('umbrella_number');
const umbrellaTotalInput=document.getElementById('umbrella_total');
const umbrellaDailyInput=document.getElementById('umbrella_daily');
const umbrellaTotalFB=document.getElementById('umbrella_total_fb');
const umbrellaDailyFB=document.getElementById('umbrella_daily_fb');

// ATTACH_DELETE_HANDLER
function attachDeleteHandler(){
  const btn = document.getElementById('deleteBookingBtn');
  if(!btn) return;
  if(btn._delHandler){ btn.removeEventListener('click', btn._delHandler); }
  const handler = function(){
    const idStr = (document.querySelector('[name="booking_id"]').value||'').trim();
    const id = Number(idStr||0);
    if(!id){ alert('ID prenotazione mancante. Apri la prenotazione e riprova.'); return; }
    if(!confirm('Eliminare definitivamente questa prenotazione?')) return;
    const idx = state.bookings.findIndex(b=>b.id===id);
    if(idx>=0){
      state.bookings.splice(idx,1);
      saveState(state);
    }
    try{ newBookingModal.hide(); }catch(e){}
    try{ renderCalendar(); }catch(e){}
    try{ renderDashboard(); }catch(e){}
    try{ renderBookingsTable(); }catch(e){}
  };
  btn.addEventListener('click', handler);
  btn._delHandler = handler;
}
(function(){
  const modalEl = document.getElementById('newBookingModal');
  if(modalEl){ modalEl.addEventListener('shown.bs.modal', attachDeleteHandler); }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', attachDeleteHandler);
  else attachDeleteHandler();
})();



function populateRoomSelect(){ roomSelect.innerHTML=state.rooms.map(r=>`<option value="${r.id}">${r.code} ‚Äì ${r.name}</option>`).join(''); }
populateRoomSelect();

paymentStatusSel.addEventListener('change',()=>{ if(paymentStatusSel.value==='deposit')depositGroup.classList.remove('d-none'); else depositGroup.classList.add('d-none'); });

function setUmbrellaUI(enabled){
  if(enabled){ if(umbrellaYes) umbrellaYes.checked=true; umbrellaExtra && umbrellaExtra.classList.remove('d-none'); }
  else { if(umbrellaNo) umbrellaNo.checked=true; umbrellaExtra && umbrellaExtra.classList.add('d-none'); }
}
umbrellaYes && umbrellaYes.addEventListener('change', ()=>{ if(umbrellaYes.checked) (umbrellaExtra && umbrellaExtra.classList.remove('d-none')); });
umbrellaNo  && umbrellaNo .addEventListener('change', ()=>{ if(umbrellaNo.checked)  (umbrellaExtra && umbrellaExtra.classList.add('d-none'));  });

function clearBookingForm(){ document.getElementById('newBookingForm').reset(); document.querySelector('[name="booking_id"]').value=''; depositGroup.classList.add('d-none'); rateTotalInput.classList.remove('is-invalid'); rateDailyInput.classList.remove('is-invalid'); rateTotalFB.textContent=''; rateDailyFB.textContent=''; }

function openNewBooking(roomId,checkinISO,checkoutISO){ populateRoomSelect(); clearBookingForm(); bookingModalTitle.textContent='Nuova prenotazione'; deleteBookingBtn.classList.add('d-none'); if(roomId){roomSelect.value=String(roomId);} checkinInput.value=checkinISO||toISO(new Date()); checkoutInput.value=checkoutISO||toISO(new Date(Date.now()+86400000)); newBookingModal.show(); }

function openEditBooking(bid){ const b=state.bookings.find(x=>x.id===bid); if(!b) return; populateRoomSelect(); clearBookingForm(); bookingModalTitle.textContent='Modifica prenotazione'; deleteBookingBtn.classList.remove('d-none'); const g=state.guests.find(gg=>gg.id===b.guest_id)||{first_name:'',last_name:'',email:'',phone:''}; const f=document.getElementById('newBookingForm'); f.elements['booking_id'].value=b.id; f.elements['first_name'].value=g.first_name||''; f.elements['last_name'].value=g.last_name||''; f.elements['email'].value=g.email||''; f.elements['phone'].value=g.phone||''; f.elements['room_id'].value=String(b.room_id); f.elements['checkin'].value=b.checkin; f.elements['checkout'].value=b.checkout; f.elements['rate_total'].value=(b.rate_total!=null?Number(b.rate_total).toFixed(2):Number(b.rate||0).toFixed(2)); f.elements['rate_daily'].value=Number(b.rate_daily||0).toFixed(2); f.elements['source'].value=b.source||'Telefono'; f.elements['payment_status'].value=b.payment_status||'unpaid'; if(b.payment_status==='deposit'){ depositGroup.classList.remove('d-none'); f.elements['deposit_amount'].value=Number(b.deposit_amount||0).toFixed(2);} f.elements['notes'].value=b.notes||''; 
 const umbE = (b.umbrella_enabled===true || b.umbrella_enabled==='yes');
 setUmbrellaUI(umbE);
 if(umbrellaYes && umbrellaNo){ if(umbE) umbrellaYes.checked=true; else umbrellaNo.checked=true; }
 if(umbE){ if(umbrellaNumberSel) umbrellaNumberSel.value=(b.umbrella_number||''); umbrellaTotalInput.value=Number(b.umbrella_total||0).toFixed(2); umbrellaDailyInput.value=Number(b.umbrella_daily||0).toFixed(2); }
 else { if(umbrellaNumberSel) umbrellaNumberSel.value=''; umbrellaTotalInput.value='0.00'; umbrellaDailyInput.value='0.00'; }
newBookingModal.show(); }

function computeNights(ci,co){ const n=Math.round((parseISO(co)-parseISO(ci))/(1000*60*60*24)); return Math.max(1,n); }
function syncRates(){ const nights=computeNights(checkinInput.value,checkoutInput.value); let total=parseFloat(rateTotalInput.value||'0'); let daily=parseFloat(rateDailyInput.value||'0'); if(document.activeElement===rateTotalInput&&total>0){ daily=total/nights; rateDailyInput.value=daily.toFixed(2);} else if(document.activeElement===rateDailyInput&&daily>0){ total=daily*nights; rateTotalInput.value=total.toFixed(2);} validateRates(); }
function validateRates(){ const nights=computeNights(checkinInput.value,checkoutInput.value); const total=parseFloat(rateTotalInput.value||'0'); const daily=parseFloat(rateDailyInput.value||'0'); let ok=true; rateTotalInput.classList.remove('is-invalid'); rateDailyInput.classList.remove('is-invalid'); rateTotalFB.textContent=''; rateDailyFB.textContent=''; if(daily>total){ ok=false; rateDailyInput.classList.add('is-invalid'); rateDailyFB.textContent='La tariffa giornaliera non pu√≤ essere maggiore del totale.'; } const expected=+(daily*nights).toFixed(2); if(total>0&&daily>0&&+(total.toFixed(2))!==expected){ ok=false; rateTotalInput.classList.add('is-invalid'); rateTotalFB.textContent=`Il totale (${total.toFixed(2)}‚Ç¨) deve corrispondere a ${nights}√ó${daily.toFixed(2)}‚Ç¨ = ${expected.toFixed(2)}‚Ç¨.`; } 
  // Controllo acconto > totale
  const depEl = document.getElementById('deposit_amount');
  const paySel = document.getElementById('payment_status');
  const depVal = parseFloat((depEl?depEl.value:'0')||'0');
  if(paySel && paySel.value==='deposit' && depVal > total){
    ok = false;
    alert(`Attenzione: l'acconto (${depVal.toFixed(2)}‚Ç¨) √® maggiore del totale (${total.toFixed(2)}‚Ç¨).`);
  }
  return ok; }

function syncUmbrella(){
  const nights = computeNights(checkinInput.value, checkoutInput.value);
  let total = parseFloat(umbrellaTotalInput.value||'0');
  let daily = parseFloat(umbrellaDailyInput.value||'0');
  if(document.activeElement===umbrellaTotalInput && total>0){ daily=total/nights; umbrellaDailyInput.value=daily.toFixed(2); }
  else if(document.activeElement===umbrellaDailyInput && daily>0){ total=daily*nights; umbrellaTotalInput.value=total.toFixed(2); }
  validateUmbrella();
}
function validateUmbrella(){
  const nights = computeNights(checkinInput.value, checkoutInput.value);
  const total = parseFloat(umbrellaTotalInput.value||'0');
  const daily = parseFloat(umbrellaDailyInput.value||'0');
  let ok = true;
  umbrellaTotalInput.classList.remove('is-invalid'); umbrellaDailyInput.classList.remove('is-invalid');
  umbrellaTotalFB.textContent=''; umbrellaDailyFB.textContent='';
  if(total>0 && daily>0 && daily>total){ ok=false; umbrellaDailyInput.classList.add('is-invalid'); umbrellaDailyFB.textContent="L'importo giornaliero non pu√≤ superare il totale."; }
  const expected = +(daily*nights).toFixed(2);
  if(total>0 && daily>0 && +(total.toFixed(2))!==expected){ ok=false; umbrellaTotalInput.classList.add('is-invalid'); umbrellaTotalFB.textContent=`Il totale (${total.toFixed(2)}‚Ç¨) deve corrispondere a ${nights}√ó${daily.toFixed(2)}‚Ç¨ = ${expected.toFixed(2)}‚Ç¨.`; }
  return ok;
}
[umbrellaTotalInput, umbrellaDailyInput, checkinInput, checkoutInput].forEach(inp=>{ inp && inp.addEventListener('input', syncUmbrella); });

[rateTotalInput,rateDailyInput,checkinInput,checkoutInput].forEach(inp=>{ inp.addEventListener('input',syncRates); });



// FIX: removed stray data-ref: /* PRENOTAZIONI */
const bkFrom=document.getElementById('bkFrom'); const bkTo=document.getElementById('bkTo'); const bkPay=document.getElementById('bkPay'); const bkSource=document.getElementById('bkSource'); const bkGuest=document.getElementById('bkGuest'); const bookingsTableBody=document.querySelector('#bookingsTable tbody');
document.getElementById('bookingsFilterForm').addEventListener('submit',(e)=>{e.preventDefault();renderBookingsTable();});
function presetBookingsFilter(){ const t=new Date(); const s=new Date(t.getFullYear(),t.getMonth(),1); const e=new Date(t.getFullYear(),t.getMonth()+1,0); bkFrom.value=toISO(s); bkTo.value=toISO(e); bkPay.value='all'; bkSource.value='all'; bkGuest.value=''; }
function renderBookingsTable(){ const start=bkFrom.value?parseISO(bkFrom.value):new Date('1970-01-01'); const endInc=bkTo.value?parseISO(bkTo.value):new Date('2999-12-31'); const endExclusive=new Date(endInc); endExclusive.setDate(endInc.getDate()+1); const payF=bkPay.value; const srcF=bkSource.value; const txt=bkGuest.value.toLowerCase(); const roomById=Object.fromEntries(state.rooms.map(r=>[r.id,r])); const guestById=Object.fromEntries(state.guests.map(g=>[g.id,g])); const list=state.bookings.filter(b=>{ if(b.status==='cancelled')return false; if(payF!=='all'&&b.payment_status!==payF)return false; if(srcF!=='all'&&b.source!==srcF)return false; const g=guestById[b.guest_id]; const matches=!txt||(g&&(`${g.first_name} ${g.last_name}`.toLowerCase().includes(txt)))||(b.notes||'').toLowerCase().includes(txt)||(g&&((g.email||'').toLowerCase().includes(txt)||(g.phone||'').toLowerCase().includes(txt))); if(!matches) return false; const bS=parseISO(b.checkin), bE=parseISO(b.checkout); return isOverlap(start,endExclusive,bS,bE); }).sort((a,b)=>a.checkin.localeCompare(b.checkin)); bookingsTableBody.innerHTML=list.map(b=>{ const g=guestById[b.guest_id]; const r=roomById[b.room_id]; const gname=g?`${g.first_name} ${g.last_name}`:''; const pay=b.payment_status==='paid'?'Pagato':b.payment_status==='deposit'?'Acconto':'Non pagato'; const dep=b.payment_status==='deposit'?fmtEUR(b.deposit_amount||0):''; const tot=Number((b.rate_total!=null?b.rate_total:(b.rate||0))); let resid=0; if(b.payment_status==='unpaid') resid=tot; else if(b.payment_status==='deposit') resid=Math.max(0,tot-Number(b.deposit_amount||0)); const residBadge = resid>0 ? ` <span class=\"badge text-bg-warning\">Residuo ‚Ç¨ ${fmtEUR(resid)}</span>` : ''; return `<tr><td>${b.id}</td><td>${r?r.code:''}</td><td>${gname}</td><td>${fromISOtoIT(b.checkin)}</td><td>${fromISOtoIT(b.checkout)}</td><td>${fmtEUR(tot)}</td><td>${fmtEUR(b.rate_daily||0)}</td><td>${dep}</td><td>${b.source||''}</td><td>${pay}${residBadge}</td><td class=\"hide-xs\">${(b.notes||'').replace(/</g,'&lt;')}</td><td><button class=\"btn btn-sm btn-primary\" onclick=\"openEditBooking(${b.id})\"><i class=\"bi bi-pencil\"></i></button></td></tr>`; }).join('')||'<tr><td colspan="12">Nessuna prenotazione</td></tr>'; }

/* RICERCA GLOBALE */
const globalSearchInput=document.getElementById('globalSearchInput'); const globalSearchBtn=document.getElementById('globalSearchBtn'); const globalSearchModal=new bootstrap.Modal(document.getElementById('globalSearchModal')); const globalSearchTableBody=document.querySelector('#globalSearchTable tbody');
globalSearchBtn.onclick=()=>{globalSearch();}; globalSearchInput.addEventListener('keydown',(e)=>{if(e.key==='Enter'){e.preventDefault();globalSearch();}});
function globalSearch(){ const q=(globalSearchInput.value||'').trim().toLowerCase(); if(!q){alert('Inserisci un testo da cercare'); return;} const roomById=Object.fromEntries(state.rooms.map(r=>[r.id,r])); const guestById=Object.fromEntries(state.guests.map(g=>[g.id,g])); const results=state.bookings.filter(b=>{ const g=guestById[b.guest_id]; const hay=[g?.first_name,g?.last_name,g?.email,g?.phone,b.notes,b.source,b.payment_status,(b.deposit_amount||'')].filter(Boolean).join(' ').toLowerCase(); return hay.includes(q); }).slice(0,300); globalSearchTableBody.innerHTML=results.map(b=>{ const g=guestById[b.guest_id]; const r=roomById[b.room_id]; const gname=g?`${g.first_name} ${g.last_name}`:''; const pay=b.payment_status==='paid'?'Pagato':b.payment_status==='deposit'?'Acconto':'Non pagato'; const dep=b.payment_status==='deposit'?fmtEUR(b.deposit_amount||0):''; return `<tr><td>${b.id}</td><td>${gname}</td><td>${fromISOtoIT(b.checkin)} ‚Üí ${fromISOtoIT(b.checkout)}</td><td>${r?r.code:''}</td><td>${b.source||''}</td><td>${pay}</td><td>${dep}</td><td>${(b.notes||'').replace(/</g,'&lt;')}</td><td><button class=\"btn btn-sm btn-primary\" onclick=\"openEditBooking(${b.id})\"><i class=\"bi bi-pencil\"></i></button></td></tr>`; }).join('')||'<tr><td colspan="9">Nessun risultato</td></tr>'; globalSearchModal.show(); }

/* REPORT */
const repFrom=document.getElementById('repFrom'); const repTo=document.getElementById('repTo'); const repForm=document.getElementById('reportForm'); const repPayFilter=document.getElementById('repPayFilter'); let occChart,revChart;
function presetReportDates(){ const t=new Date(); const s=new Date(t.getFullYear(),t.getMonth(),1); const e=new Date(t.getFullYear(),t.getMonth()+1,0); repFrom.value=toISO(s); repTo.value=toISO(e); }
repForm.addEventListener('submit',(e)=>{e.preventDefault(); computeReport();});
function computeReport(){
  const start=parseISO(repFrom.value); const endInc=parseISO(repTo.value); if(isNaN(start)||isNaN(endInc))return; const endExclusive=new Date(endInc); endExclusive.setDate(endInc.getDate()+1);
  const roomsCount=state.rooms.length||1; const days=eachDay(start,endExclusive);
  const payFilter=repPayFilter.value; const perDay=days.map(d=>{ const ds=toISO(d); const sold=state.bookings.filter(b=>{ if(b.status==='cancelled')return false; if(payFilter!=='all'&&b.payment_status!==payFilter)return false; return (b.checkin<=ds)&&(ds<b.checkout); }).length; return {date:ds,sold,revenue:0}; });
  const filteredBookings=state.bookings.filter(b=>{ if(b.status==='cancelled')return false; if(payFilter!=='all'&&b.payment_status!==payFilter)return false; const bS=parseISO(b.checkin), bE=parseISO(b.checkout); return isOverlap(start,endExclusive,bS,bE); });
  // KPI globali su TUTTE le prenotazioni nel periodo
  const allBookingsInPeriod = state.bookings.filter(b=>{ if(b.status==='cancelled')return false; const bS=parseISO(b.checkin), bE=parseISO(b.checkout); return isOverlap(start,endExclusive,bS,bE); });
  const paidRevenue = allBookingsInPeriod.reduce((s,b)=>{ const tot=Number((b.rate_total!=null?b.rate_total:(b.rate||0))); if(b.payment_status==='paid') return s+tot; if(b.payment_status==='deposit') return s+Number(b.deposit_amount||0); return s; },0);
  const totalAll = allBookingsInPeriod.reduce((s,b)=> s + Number((b.rate_total!=null?b.rate_total:(b.rate||0))), 0);
  const outstanding = allBookingsInPeriod.reduce((s,b)=>{ const tot=Number((b.rate_total!=null?b.rate_total:(b.rate||0))); if(b.payment_status==='paid') return s; if(b.payment_status==='unpaid') return s+tot; const dep = Number(b.deposit_amount||0); return s + Math.max(tot-dep,0); },0);
  document.getElementById('repRevenue').textContent = fmtEUR(paidRevenue);
  document.getElementById('repTotalAll').textContent = fmtEUR(totalAll);
  document.getElementById('repOutstanding').textContent = fmtEUR(outstanding);

  // Grafico Incassi effettivi (‚Ç¨) attribuiti alla data di check-in
  const labels=days.map(d=>toISO(d).substring(5));
  const cashPerDay = days.map(()=>0);
  for(const b of allBookingsInPeriod){ const ci=parseISO(b.checkin); if(ci>=start && ci<endExclusive){ const idx=Math.floor((ci-start)/(1000*60*60*24)); const tot=Number((b.rate_total!=null?b.rate_total:(b.rate||0))); let inc=0; if(b.payment_status==='paid') inc=tot; else if(b.payment_status==='deposit') inc=Number(b.deposit_amount||0); cashPerDay[idx]+=inc; } }

  // Tabella Dettaglio occupazione (metrica distribuita a notte)
  for(const b of filteredBookings){ const bS=parseISO(b.checkin), bE=parseISO(b.checkout); const nights=Math.max(1,Math.round((bE-bS)/(1000*60*60*24))); const tot=(b.rate_total!=null?b.rate_total:(b.rate||0)); const perNight=Number(tot)/nights; for(let d=new Date(bS); d<bE; d.setDate(d.getDate()+1)){ if(d>=start&&d<endExclusive){ const idx=Math.floor((d-start)/(1000*60*60*24)); if(perDay[idx]) perDay[idx].revenue+=perNight; } } }

  const tbody=document.querySelector('#repTable tbody'); tbody.innerHTML=perDay.map(r=>`<tr><td>${r.date}</td><td>${r.sold}</td><td>${fmtEUR(r.revenue)}</td></tr>`).join('');

  const sb=document.querySelector('#repSources tbody'); const bySource={}; filteredBookings.forEach(b=>{ if(!bySource[b.source])bySource[b.source]={count:0,revenue:0}; bySource[b.source].count+=1; bySource[b.source].revenue+=Number((b.rate_total!=null?b.rate_total:(b.rate||0))); }); sb.innerHTML=Object.keys(bySource).length?Object.entries(bySource).map(([s,v])=>`<tr><td>${s}</td><td>${v.count}</td><td>${fmtEUR(v.revenue)}</td></tr>`).join(''):'<tr><td colspan="3">Nessun dato</td></tr>';

  // Chart
  if(occChart)occChart.destroy(); if(revChart)revChart.destroy();
  const baseOpts={responsive:true,maintainAspectRatio:false,animation:false};
  occChart=new Chart(document.getElementById('occChart'),{type:'line',data:{labels:labels,datasets:[{label:'Occupazione %',data:perDay.map(r=>Number(((r.sold/roomsCount)*100).toFixed(2))),borderColor:'#0ea5a6',backgroundColor:'#0ea5a6',fill:false}]},options:{...baseOpts,scales:{y:{beginAtZero:true,max:100}}}});
  revChart=new Chart(document.getElementById('revChart'),{type:'bar',data:{labels:labels,datasets:[{label:'Incassi effettivi (‚Ç¨)',data:cashPerDay.map(v=>Number(v.toFixed(2))),backgroundColor:'#ff7043'}]},options:{...baseOpts,scales:{y:{beginAtZero:true}}}});
}

/* EXPORT */
function exportExcel(){ const wb=XLSX.utils.book_new(); const roomsAoA=[["id","code","name","capacity","status"]]; state.rooms.forEach(r=>roomsAoA.push([r.id,r.code,r.name,r.capacity,r.status])); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(roomsAoA),'Rooms'); const guestsAoA=[["id","first_name","last_name","email","phone"]]; state.guests.forEach(g=>guestsAoA.push([g.id,g.first_name,g.last_name,g.email,g.phone])); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(guestsAoA),'Guests'); const roomById=Object.fromEntries(state.rooms.map(r=>[r.id,r])); const guestById=Object.fromEntries(state.guests.map(g=>[g.id,g])); const bkAoA=[["id","room_id","room_code","guest_id","guest_name","checkin","checkout","status","rate_total","rate_daily","source","payment_status","deposit_amount","notes"]]; state.bookings.forEach(b=>{ const gr=guestById[b.guest_id]; const rr=roomById[b.room_id]; const gname=gr?(gr.first_name+" "+gr.last_name):''; const rcode=rr?rr.code:''; bkAoA.push([b.id,b.room_id,rcode,b.guest_id,gname,b.checkin,b.checkout,b.status,Number(b.rate_total!=null?b.rate_total:(b.rate||0)),Number(b.rate_daily||0),b.source,b.payment_status||'',Number(b.deposit_amount||0),b.notes||'']); }); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(bkAoA),'Bookings'); const start=repFrom.value?parseISO(repFrom.value):new Date(); const endInc=repTo.value?parseISO(repTo.value):new Date(); const endExclusive=new Date(endInc); endExclusive.setDate(endInc.getDate()+1); const payFilter=repPayFilter.value||'all'; const days=eachDay(start,endExclusive); const perDayRows=[["Data","Camere vendute","Incasso (‚Ç¨)"]]; const perDay=days.map(d=>{ const ds=toISO(d); const sold=state.bookings.filter(b=>{ if(b.status==='cancelled')return false; if(payFilter!=='all'&&b.payment_status!==payFilter)return false; return (b.checkin<=ds)&&(ds<b.checkout);}).length; return {date:ds,sold,revenue:0}; }); const bookings=state.bookings.filter(b=>{ if(b.status==='cancelled')return false; if(payFilter!=='all'&&b.payment_status!==payFilter)return false; const bS=parseISO(b.checkin), bE=parseISO(b.checkout); return isOverlap(start,endExclusive,bS,bE); }); for(const b of bookings){ const bS=parseISO(b.checkin), bE=parseISO(b.checkout); const nights=Math.max(1,Math.round((bE-bS)/(1000*60*60*24))); const perNight=Number((b.rate_total!=null?b.rate_total:(b.rate||0)))/nights; for(let d=new Date(bS); d<bE; d.setDate(d.getDate()+1)){ if(d>=start&&d<endExclusive){ const idx=Math.floor((d-start)/(1000*60*60*24)); if(perDay[idx]) perDay[idx].revenue+=perNight; } } } perDay.forEach(r=>perDayRows.push([r.date,r.sold,Number(r.revenue.toFixed(2))])); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(perDayRows),'Report'); XLSX.writeFile(wb,'bb_california_export.xlsx'); }

document.getElementById('btnExport').onclick=exportExcel;

document.getElementById('btnReset').onclick=()=>{ if(confirm('Sicuro di voler cancellare tutti i dati locali?')){ localStorage.removeItem(LS_KEY); state=loadState(); renderCalendar(); renderDashboard(); renderRooms(); renderBookingsTable(); } };

/* CAMERE */
const roomsBody=document.getElementById('roomsBody');
function renderRooms(){ roomsBody.innerHTML=state.rooms.map(r=>`<tr><td style=\"width:90px\"><input class=\"form-control form-control-sm\" value=\"${r.code}\" data-rid=\"${r.id}\" data-k=\"code\"></td><td><input class=\"form-control form-control-sm\" value=\"${r.name}\" data-rid=\"${r.id}\" data-k=\"name\"></td><td style=\"width:120px\"><input type=\"number\" class=\"form-control form-control-sm\" min=\"1\" value=\"${r.capacity}\" data-rid=\"${r.id}\" data-k=\"capacity\"></td><td style=\"width:220px\"><select class=\"form-select form-select-sm\" data-rid=\"${r.id}\" data-k=\"status\"><option value=\"available\" ${r.status==='available'?'selected':''}>Disponibile</option><option value=\"maintenance\" ${r.status==='maintenance'?'selected':''}>Manutenzione</option><option value=\"out_of_order\" ${r.status==='out_of_order'?'selected':''}>Fuori servizio</option></select></td><td style=\"width:140px\"><button class=\"btn btn-sm btn-primary\" onclick=\"saveRoom(${r.id})\">Salva</button></td></tr>`).join(''); }
function saveRoom(id){ const inputs=roomsBody.querySelectorAll(`[data-rid=\"${id}\"]`); const r=state.rooms.find(x=>x.id===id); inputs.forEach(inp=>{ const k=inp.getAttribute('data-k'); let val=inp.value; if(k==='capacity') val=Number(val||1); r[k]=val; }); saveState(state); renderCalendar(); alert('Camera aggiornata.'); }

/* AVVIO */
try{renderDashboard();}catch(e){console.error(e);} try{renderCalendar();}catch(e){console.error(e);} try{renderRooms();}catch(e){console.error(e);} try{presetBookingsFilter(); renderBookingsTable();}catch(e){console.error(e);} show(viewCalendar);
</script>
<script>
(function(){
  function enhanceHorizontalScroll(){
    const cc = document.getElementById('calendarContainer');
    if(!cc) return;
    let hint = cc.querySelector('.scroll-hint');
    if(!hint){
      hint = document.createElement('div');
      hint.className='scroll-hint';
      hint.textContent='Scorri ‚Üí';
      cc.appendChild(hint);
    }
    hint.style.display='';
    cc.addEventListener('scroll', ()=>{ hint.style.display='none'; }, {passive:true});
    setTimeout(()=>{ hint && (hint.style.display='none'); }, 2000);
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    try{ enhanceHorizontalScroll(); }catch(e){}
    // Hook common calendar controls to re-show hint after rerender
    const ids=['prevWeek','nextWeek','todayBtn','jumpGo','rangeSelect'];
    ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('click', ()=>setTimeout(enhanceHorizontalScroll, 200)); el.addEventListener('change', ()=>setTimeout(enhanceHorizontalScroll, 200)); } });
  });
})();
</script>
<script>
// /* KPI reorder runtime */
(function(){
  function reorderReportKPI(){
    const repSection = document.getElementById('viewReports'); if(!repSection) return;
    const rows = repSection.querySelectorAll('div.row.g-3.mb-3'); let kpiRow=null;
    for(const r of rows){ if(r.querySelector('#repRevenue')&&r.querySelector('#repOutstanding')&&r.querySelector('#repTotalAll')){ kpiRow=r; break; } }
    if(!kpiRow) return;
    const getCard=id=>{ const el=kpiRow.querySelector('#'+id); return el?el.closest('.col-md-4'):null; };
    const cR=getCard('repRevenue'), cO=getCard('repOutstanding'), cT=getCard('repTotalAll'); if(!(cR&&cO&&cT)) return;
    const setT=(c,t)=>{ const b=c.querySelector('b'); if(b) b.textContent=t; };
    setT(cR,'Incassi ‚Ç¨'); setT(cO,'Da incassare ‚Ç¨'); setT(cT,'Ricavi ‚Ç¨');
    const frag=document.createDocumentFragment(); frag.appendChild(cR); frag.appendChild(cO); frag.appendChild(cT); kpiRow.appendChild(frag);
    const legend = repSection.querySelector('.alert.alert-info ul'); if(legend){ legend.innerHTML = `
      <li><b>Incassi ‚Ç¨</b>: somme <u>effettivamente incassate</u> nel periodo (Pagato = 100% del totale; Acconto = solo importo acconto; Non pagato = 0).</li>
      <li><b>Ricavi ‚Ç¨</b>: somma di <u>tutti i totali</u> delle prenotazioni nel periodo (pagate e non).</li>
      <li><b>Da incassare ‚Ç¨</b>: importo <u>ancora da incassare</u> (Non pagato = 100% del totale; Acconto = Totale ‚àí Acconto; Pagato = 0).</li>
      <li class="mt-1"><b>Incassi effettivi (grafico)</b>: attribuiti alla <u>data di check‚Äëin</u> della prenotazione (senza data incasso puntuale).</li>`; }
  }
  document.addEventListener('DOMContentLoaded', reorderReportKPI);
})();
</script>
<script>
(function(){
  function removeToolbarButtons(){
    const nav=document.querySelector('nav.toolbar, .toolbar'); if(!nav) return;
    const gear=nav.querySelector('i.bi.bi-gear'); if(gear){ const g=gear.closest('.btn-group'); if(g) g.remove(); }
    const reset=nav.querySelector('#btnReset'); if(reset) reset.remove();
  }
  document.addEventListener('DOMContentLoaded', removeToolbarButtons);
})();

// Restore Save button handler (Salva prenotazione)
function onSaveBookingClick(){
  try{
    const form = document.getElementById('newBookingForm');
    if(!form){ alert('Form non trovato.'); return; }
    const data = Object.fromEntries(new FormData(form).entries());
    if(!data.checkin || !data.checkout){ alert('Compila date'); return; }
    if(data.checkout <= data.checkin){ alert('Checkout deve essere successivo al check‚Äëin'); return; }
    if(typeof upsertBooking !== 'function'){ alert('Funzione salvataggio mancante.'); return; }
    if(upsertBooking(data)){
      if(window.newBookingModal && typeof newBookingModal.hide==='function') newBookingModal.hide();
      if(typeof renderCalendar==='function') renderCalendar();
      if(typeof renderDashboard==='function') renderDashboard();
      if(typeof renderBookingsTable==='function') renderBookingsTable();
      alert('Prenotazione salvata.');
    }
  }catch(e){ console.error('Errore salvataggio:', e); alert('Errore salvataggio: '+e.message); }
}
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('saveBookingBtn');
  if(btn && !btn._bkHandler){ btn.addEventListener('click', onSaveBookingClick); btn._bkHandler=true; }
});


function upsertBooking(data){
  const room_id = Number(data.room_id);
  const checkin = data.checkin;
  const checkout = data.checkout;
  const aStart = parseISO(checkin), aEnd = parseISO(checkout);
  const editingId = data.booking_id ? Number(data.booking_id) : null;

  const conflict = state.bookings.some(b=>{
    if(b.status==='cancelled') return false;
    if(b.room_id!==room_id) return false;
    if(editingId && b.id===editingId) return false;
    const bStart=parseISO(b.checkin), bEnd=parseISO(b.checkout);
    return isOverlap(aStart,aEnd,bStart,bEnd);
  });
  if(conflict){ alert('Overbooking: la camera non √® disponibile.'); return false; }

  if(!validateRates()){ alert('Correggi le tariffe prima di salvare.'); return false; }

  const rate_total = Number(document.getElementById('rate_total').value||0);
  const rate_daily = Number(document.getElementById('rate_daily').value||0);

  const paySel = document.getElementById('payment_status');
  const depEl  = document.getElementById('deposit_amount');
  const depVal = (paySel && paySel.value==='deposit') ? Number((depEl||{}).value||0) : 0;
  if(paySel && paySel.value==='deposit' && depVal>rate_total){
    alert("Attenzione: l'acconto √® maggiore del totale");
    return false;
  }

  // Ombrellone (supporta 'yes'/'no' e calcolo automatico se manca uno dei due importi)
  const umbEnabledStr = (data.umbrella_enabled||'no');
  const umbEnabled = (umbEnabledStr === 'yes');
 // REQUIRE_UMBRELLA_NUMBER_BLOCK: Ombrellone richiede numero 1‚Äì6 se abilitato
 if(umbEnabled){
   const sel = document.getElementById('umbrella_number');
   const fb = document.getElementById('umbrella_number_fb');
   const val = (data.umbrella_number || '').trim();
   const valid = ['1','2','3','4','5','6'].includes(val);
   if(!valid){
     if(sel){ sel.classList.add('is-invalid'); sel.focus(); }
     if(fb){ fb.textContent = 'Se scegli ‚ÄúS√¨‚Äù, devi selezionare un numero da 1 a 6.'; fb.style.display='block'; }
     alert('Se scegli ‚ÄúS√¨‚Äù, devi selezionare un numero da 1 a 6.');
     return false;
   }
 } else {
   const sel = document.getElementById('umbrella_number');
   const fb = document.getElementById('umbrella_number_fb');
   if(sel){ sel.classList.remove('is-invalid'); sel.removeAttribute('required'); }
   if(fb){ fb.style.display='none'; }
 }

 // Safeguard: if Ombrellone = No, ensure the number is not required
 if(!umbEnabled){ const sel=document.getElementById('umbrella_number'); if(sel) sel.removeAttribute('required'); }

  const umbNumber  = umbEnabled ? (Number(data.umbrella_number||0) || null) : null;
  let   umbTotal   = umbEnabled ? Number((data.umbrella_total||0)) : 0;
  let   umbDaily   = umbEnabled ? Number((data.umbrella_daily||0)) : 0;
  if(umbEnabled){
    const nightsUM = Math.max(1, Math.round((parseISO(checkin)-0 - (parseISO(checkin)-0) + (parseISO(checkout)-parseISO(checkin)))/(1000*60*60*24)));
    const nights = Math.max(1, Math.round((parseISO(checkout)-parseISO(checkin))/(1000*60*60*24)));
    const N = nightsUM || nights;
    if(umbTotal>0 && umbDaily===0 && N>0){ umbDaily = +(umbTotal/N).toFixed(2); }
    if(umbDaily>0 && umbTotal===0 && N>0){ umbTotal = +(umbDaily*N).toFixed(2); }
  }

  if(editingId){
    const b = state.bookings.find(x=>x.id===editingId);
    const g = state.guests.find(gg=>gg.id===b.guest_id);
    if(g){ g.first_name=data.first_name; g.last_name=data.last_name; g.email=data.email||''; g.phone=data.phone||''; }
    b.room_id=room_id; b.checkin=checkin; b.checkout=checkout;
    b.rate_total=rate_total; b.rate_daily=rate_daily; b.rate=rate_total;
    b.source=data.source||'Telefono';
    b.payment_status=data.payment_status||'unpaid';
    b.deposit_amount=(b.payment_status==='deposit')?Number(data.deposit_amount||0):0;
    b.notes=data.notes||'';
    b.umbrella_enabled=umbEnabled; b.umbrella_number=umbNumber; b.umbrella_total=umbTotal; b.umbrella_daily=umbDaily;
  } else {
    const guestId=(state.guests.at(-1)?.id||0)+1;
    state.guests.push({id:guestId,first_name:data.first_name,last_name:data.last_name,email:data.email||'',phone:data.phone||''});
    const bookingId=(state.bookings.at(-1)?.id||0)+1;
    state.bookings.push({
      id:bookingId, room_id, guest_id:guestId, checkin, checkout, status:'confirmed',
      rate_total, rate_daily, rate:rate_total, source:data.source||'Telefono',
      payment_status:data.payment_status||'unpaid', deposit_amount:(data.payment_status==='deposit')?Number(data.deposit_amount||0):0,
      notes:data.notes||'',
      umbrella_enabled:umbEnabled, umbrella_number:umbNumber, umbrella_total:umbTotal, umbrella_daily:umbDaily
    });
  }

  saveState(state);
  return true;
}
</script>
<script>
// UMBRELLA_REQUIRED_BEHAVIOR
(function(){
  function setupUmbrellaRequirement(){
    var umbYes = document.getElementById('umb_yes');
    var umbNo  = document.getElementById('umb_no');
    var sel    = document.getElementById('umbrella_number');
    var fb     = document.getElementById('umbrella_number_fb');
    if(!sel) return;
    function updateReq(){
      if(umbYes && umbYes.checked){
        sel.setAttribute('required','required');
      } else {
        sel.removeAttribute('required');
        sel.classList.remove('is-invalid');
        if(fb) fb.style.display='none';
        sel.value = sel.value; // no-op to keep state
      }
    }
    if(umbYes) umbYes.addEventListener('change', updateReq);
    if(umbNo)  umbNo.addEventListener('change', updateReq);
    if(sel) sel.addEventListener('change', function(){ if(sel.value){ sel.classList.remove('is-invalid'); if(fb) fb.style.display='none'; } });
    // On modal show, re-evaluate requirement (covers Edit vs New)
    var modalEl = document.getElementById('newBookingModal');
    if(modalEl){ modalEl.addEventListener('shown.bs.modal', updateReq); }
    // Initial
    updateReq();
    // expose for other scripts
    window._updateUmbrellaRequirement = updateReq;
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', setupUmbrellaRequirement); }
  else { setupUmbrellaRequirement(); }
})();
</script>

<script src="bb_pms_cloudsync.js?v=6"></script></body>
  <!-- DEBUG: Indicatore Ultimo cloud / eTag + Forza salvataggio -->
<script>
  (function(){
    function addCloudDebug(){
      var bar = document.querySelector('#cloudToolbar');
      if(!bar || document.getElementById('cloudDebug')) return;

      var d = document.createElement('div');
      d.id = 'cloudDebug';
      d.className = 'small text-muted';
      d.style.marginLeft = '12px';
      d.innerHTML = 'Ultimo cloud: <span id="cdUpdated">‚Äî</span> ¬∑ eTag: <span id="cdETag">‚Äî</span> ' +
                    '<button id="cdForce" class="btn btn-sm btn-outline-secondary ms-2">Forza salvataggio (debug)</button>';
      bar.appendChild(d);

      document.getElementById('cdForce').onclick = async function(){
        try {
          if (typeof window.cloudSave !== 'function') throw new Error('cloudSave non disponibile');
          await window.cloudSave(true);
          localStorage.setItem('bb_pms_last_cloud_updatedAt', new Date().toISOString());
          alert('Salvato su cloud.');
          update();
        } catch(e){
          alert('Errore salvataggio: ' + e.message);
        }
      };

      function update(){
        try{
          var meta = (typeof window.getCloudMeta === 'function') ? window.getCloudMeta() : {};
          var e = meta.eTag || '‚Äî';
          var u = (window.state && window.state.__updatedAt) ||
                  localStorage.getItem('bb_pms_last_cloud_updatedAt') || '‚Äî';
          document.getElementById('cdETag').textContent = e;
          document.getElementById('cdUpdated').textContent = u;
        }catch(_){ }
      }

      update();
      setInterval(update, 5000);
    }

    (function patchCloudSaveTimestamp(){
      if (typeof window.cloudSave !== 'function') { setTimeout(patchCloudSaveTimestamp, 800); return; }
      if (window.cloudSave.__patched) return;
      var _cs = window.cloudSave;
      window.cloudSave = async function(force){
        var ok = await _cs(force);
        try {
          var now = new Date().toISOString();
          if (window.state) window.state.__updatedAt = now;
          localStorage.setItem('bb_pms_last_cloud_updatedAt', now);
        } catch(_){ }
        return ok;
      };
      window.cloudSave.__patched = true;
    })();

    document.addEventListener('DOMContentLoaded', addCloudDebug);
  })();
</script>
</html>
